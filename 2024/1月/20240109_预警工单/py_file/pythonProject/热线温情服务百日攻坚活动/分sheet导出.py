# coding=utf-8
import pandas as pd
import pymysql

# 在mysql中导入2张明细表 2张统计表


# 连接到MySQL数据库
connection = pymysql.connect(
    host='localhost',
    user='root',
    password='123456',
    database='fwbz'
)

# 日期
dt = '0428new'

fwbz_table='100day_0428_2'

# 三个中心抽检情况周通报
query1 = f"with t1 as (select 抽检单位,                    count(*)                                                                            as `抽检总量`,                    count(case when 听得懂（必填）不合格问题 = '倾听/引导不到位' then 1 else null end)    as `倾听/引导不到位`,                    count(case when 听得懂（必填）不合格问题 = '答非所问' then 1 else null end)           as `答非所问`,                    count(case when 听得懂（必填）不合格问题 = '未纠正客户错误信息' then 1 else null end) as `未纠正客户错误信息`,                    count(case                              when 听得懂（必填）不合格问题 in ('倾听/引导不到位', '答非所问', '未纠正客户错误信息')                                  then 1                              else null end)                                                            as `问题小计`             from fwbz.{fwbz_table}             group by 抽检单位             union all             select '合计'                                                                              as 抽检单位,                    count(*)                                                                            as `抽检总量`,                    count(case when 听得懂（必填）不合格问题 = '倾听/引导不到位' then 1 else null end)    as `倾听/引导不到位`,                    count(case when 听得懂（必填）不合格问题 = '答非所问' then 1 else null end)           as `答非所问`,                    count(case when 听得懂（必填）不合格问题 = '未纠正客户错误信息' then 1 else null end) as `未纠正客户错误信息`,                    count(case                              when 听得懂（必填）不合格问题 in ('倾听/引导不到位', '答非所问', '未纠正客户错误信息')                                  then 1                              else null end)                                                            as `问题小计`             from fwbz.{fwbz_table}),      t2 as (select 抽检单位,                    count(*)                                                                                as `抽检总量`,                    count(case when 讲得清（必填）不合格问题 = '超长等候未告知' then 1 else null end)         as `超长等候未告知`,                    count(case when 讲得清（必填）不合格问题 = '沟通/受理能力差' then 1 else null end)        as `沟通/受理能力差`,                    count(case when 讲得清（必填）不合格问题 = '服务态度差' then 1 else null end)             as `服务态度差`,                    count(case when 讲得清（必填）不合格问题 = '温情服务不足' then 1 else null end)           as `温情服务不足`,                    count(case when 讲得清（必填）不合格问题 = '介绍错误或关键信息不全' then 1 else null end) as `介绍错误或关键信息不全`,                    count(case                              when 讲得清（必填）不合格问题 in                                   ('超长等候未告知', '沟通/受理能力差', '服务态度差', '温情服务不足',                                    '介绍错误或关键信息不全')                                  then 1                              else null end)                                                                as `问题小计`             from fwbz.{fwbz_table}             group by 抽检单位             union all             select '合计'                                                                              as 抽检单位,                    count(*)                                                                                as `抽检总量`,                    count(case when 讲得清（必填）不合格问题 = '超长等候未告知' then 1 else null end)         as `超长等候未告知`,                    count(case when 讲得清（必填）不合格问题 = '沟通/受理能力差' then 1 else null end)        as `沟通/受理能力差`,                    count(case when 讲得清（必填）不合格问题 = '服务态度差' then 1 else null end)             as `服务态度差`,                    count(case when 讲得清（必填）不合格问题 = '温情服务不足' then 1 else null end)           as `温情服务不足`,                    count(case when 讲得清（必填）不合格问题 = '介绍错误或关键信息不全' then 1 else null end) as `介绍错误或关键信息不全`,                    count(case                              when 讲得清（必填）不合格问题 in                                   ('超长等候未告知', '沟通/受理能力差', '服务态度差', '温情服务不足',                                    '介绍错误或关键信息不全')                                  then 1                              else null end)                                                                as `问题小计`             from fwbz.{fwbz_table}),      t3 as (select 抽检单位,                    count(*)                                                                                          as `抽检总量`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '推诿' then 1 else null end)                 as `推诿`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '未按客户需求受理业务' then 1 else null end) as `未按客户需求受理业务`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '未按规范执行' then 1 else null end)         as `未按规范执行`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '工单受理不规范' then 1 else null end)       as `工单受理不规范`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '工单无需生成' then 1 else null end)         as `工单无需生成`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '工单记录信息有误' then 1 else null end)     as `工单记录信息有误`,                    count(case                              when 解得对（一线话务员）（必填）不合格问题 in                                   ('推诿', '未按客户需求受理业务', '未按规范执行', '工单受理不规范',                                    '工单无需生成', '工单记录信息有误')                                  then 1                              else null end)                                                                          as `问题小计`             from fwbz.{fwbz_table}             group by 抽检单位             union all             select '合计'                                                                              as 抽检单位,                    count(*)                                                                                          as `抽检总量`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '推诿' then 1 else null end)                 as `推诿`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '未按客户需求受理业务' then 1 else null end) as `未按客户需求受理业务`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '未按规范执行' then 1 else null end)         as `未按规范执行`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '工单受理不规范' then 1 else null end)       as `工单受理不规范`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '工单无需生成' then 1 else null end)         as `工单无需生成`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '工单记录信息有误' then 1 else null end)     as `工单记录信息有误`,                    count(case                              when 解得对（一线话务员）（必填）不合格问题 in                                   ('推诿', '未按客户需求受理业务', '未按规范执行', '工单受理不规范',                                    '工单无需生成', '工单记录信息有误')                                  then 1                              else null end)                                                                          as `问题小计`             from fwbz.{fwbz_table}) select t1.抽检单位,        t1.抽检总量,        t1.`倾听/引导不到位`,        t1.答非所问,        t1.未纠正客户错误信息,        t1.问题小计,        (t1.抽检总量 - t1.问题小计) / t1.抽检总量 as `听得懂合规率（目标值≥95%）`,        t2.超长等候未告知,        t2.`沟通/受理能力差`,        t2.服务态度差,        t2.温情服务不足,        t2.介绍错误或关键信息不全,        t2.问题小计,        (t2.抽检总量 - t2.问题小计) / t2.抽检总量 as `讲得清合规率（目标值≥95%）`,        t3.推诿,        t3.未按客户需求受理业务,        t3.未按规范执行,        t3.工单受理不规范,        t3.工单无需生成,        t3.工单记录信息有误,        t3.问题小计,        (t3.抽检总量 - t3.问题小计) / t3.抽检总量 as `解得对合规率（目标值≥95%）` from t1          join t2 on t1.抽检单位 = t2.抽检单位          join t3 on t1.抽检单位 = t3.抽检单位 order by case              when t1.抽检单位 = '热线' then 1              when t1.抽检单位 = '升投' then 2              when t1.抽检单位 = '客户体验' then 3              when t1.抽检单位 = '合计' then 4              end ;"
df1 = pd.read_sql(query1, connection)

# 区域合规率
query2 = f"with t1 as (select 区域,                    抽检总量,                    `倾听/引导不到位`,                    答非所问,                    未纠正客户错误信息,                    问题小计,                    (抽检总量 - 问题小计) / 抽检总量 as `听得懂合规率（目标值≥95%）`             from (select 区域,                          count(*)                                                                            as `抽检总量`,                          count(case when 听得懂（必填）不合格问题 = '倾听/引导不到位' then 1 else null end)    as `倾听/引导不到位`,                          count(case when 听得懂（必填）不合格问题 = '答非所问' then 1 else null end)           as `答非所问`,                          count(case when 听得懂（必填）不合格问题 = '未纠正客户错误信息' then 1 else null end) as `未纠正客户错误信息`,                          count(case                                    when 听得懂（必填）不合格问题 in ('倾听/引导不到位', '答非所问', '未纠正客户错误信息')                                        then 1                                    else null end)                                                            as `问题小计`                   from fwbz.{fwbz_table}                   group by 区域                   union all                   select '全国'                                                                              as 区域,                          count(*)                                                                            as `抽检总量`,                          count(case when 听得懂（必填）不合格问题 = '倾听/引导不到位' then 1 else null end)    as `倾听/引导不到位`,                          count(case when 听得懂（必填）不合格问题 = '答非所问' then 1 else null end)           as `答非所问`,                          count(case when 听得懂（必填）不合格问题 = '未纠正客户错误信息' then 1 else null end) as `未纠正客户错误信息`,                          count(case                                    when 听得懂（必填）不合格问题 in ('倾听/引导不到位', '答非所问', '未纠正客户错误信息')                                        then 1                                    else null end)                                                            as `问题小计`                   from fwbz.{fwbz_table}) t1             order by case                          when 区域 = '全国' then 1                          when 区域 = '北方一中心' then 2                          when 区域 = '北方二中心' then 3                          when 区域 = '南方一中心' then 4                          when 区域 = '南方二中心' then 5 end),      t2 as (select 区域,                    抽检总量,                    超长等候未告知,                    `沟通/受理能力差`,                    服务态度差,                    温情服务不足,                    介绍错误或关键信息不全,                    问题小计,                    (抽检总量 - 问题小计) / 抽检总量 as `讲得清合规率（目标值≥95%）`             from (select 区域,                          count(*)                                                                                as `抽检总量`,                          count(case when 讲得清（必填）不合格问题 = '超长等候未告知' then 1 else null end)         as `超长等候未告知`,                          count(case when 讲得清（必填）不合格问题 = '沟通/受理能力差' then 1 else null end)        as `沟通/受理能力差`,                          count(case when 讲得清（必填）不合格问题 = '服务态度差' then 1 else null end)             as `服务态度差`,                          count(case when 讲得清（必填）不合格问题 = '温情服务不足' then 1 else null end)           as `温情服务不足`,                          count(case when 讲得清（必填）不合格问题 = '介绍错误或关键信息不全' then 1 else null end) as `介绍错误或关键信息不全`,                          count(case                                    when 讲得清（必填）不合格问题 in                                         ('超长等候未告知', '沟通/受理能力差', '服务态度差', '温情服务不足',                                          '介绍错误或关键信息不全')                                        then 1                                    else null end)                                                                as `问题小计`                   from fwbz.{fwbz_table}                   group by 区域                   union all                   select '全国'                                                                                  as 区域,                          count(*)                                                                                as `抽检总量`,                          count(case when 讲得清（必填）不合格问题 = '超长等候未告知' then 1 else null end)         as `超长等候未告知`,                          count(case when 讲得清（必填）不合格问题 = '沟通/受理能力差' then 1 else null end)        as `沟通/受理能力差`,                          count(case when 讲得清（必填）不合格问题 = '服务态度差' then 1 else null end)             as `服务态度差`,                          count(case when 讲得清（必填）不合格问题 = '温情服务不足' then 1 else null end)           as `温情服务不足`,                          count(case when 讲得清（必填）不合格问题 = '介绍错误或关键信息不全' then 1 else null end) as `介绍错误或关键信息不全`,                          count(case                                    when 讲得清（必填）不合格问题 in                                         ('超长等候未告知', '沟通/受理能力差', '服务态度差', '温情服务不足',                                          '介绍错误或关键信息不全')                                        then 1                                    else null end)                                                                as `问题小计`                   from fwbz.{fwbz_table}) t1             order by case                          when 区域 = '全国' then 1                          when 区域 = '北方一中心' then 2                          when 区域 = '北方二中心' then 3                          when 区域 = '南方一中心' then 4                          when 区域 = '南方二中心' then 5 end),      t3 as (select 区域,                    抽检总量,                    推诿,                    未按客户需求受理业务,                    未按规范执行,                    工单受理不规范,                    工单无需生成,                    工单记录信息有误,                    问题小计,                    (抽检总量 - 问题小计) / 抽检总量 as `解得对合规率（目标值≥95%）`             from (select 区域,                          count(*)                                                                                          as `抽检总量`,                          count(case when 解得对（一线话务员）（必填）不合格问题 = '推诿' then 1 else null end)                 as `推诿`,                          count(case when 解得对（一线话务员）（必填）不合格问题 = '未按客户需求受理业务' then 1 else null end) as `未按客户需求受理业务`,                          count(case when 解得对（一线话务员）（必填）不合格问题 = '未按规范执行' then 1 else null end)         as `未按规范执行`,                          count(case when 解得对（一线话务员）（必填）不合格问题 = '工单受理不规范' then 1 else null end)       as `工单受理不规范`,                          count(case when 解得对（一线话务员）（必填）不合格问题 = '工单无需生成' then 1 else null end)         as `工单无需生成`,                          count(case when 解得对（一线话务员）（必填）不合格问题 = '工单记录信息有误' then 1 else null end)     as `工单记录信息有误`,                          count(case                                    when 解得对（一线话务员）（必填）不合格问题 in                                         ('推诿', '未按客户需求受理业务', '未按规范执行', '工单受理不规范',                                          '工单无需生成', '工单记录信息有误')                                        then 1                                    else null end)                                                                          as `问题小计`                   from fwbz.{fwbz_table}                   group by 区域                   union all                   select '全国'                                                                                            as 区域,                          count(*)                                                                                          as `抽检总量`,                          count(case when 解得对（一线话务员）（必填）不合格问题 = '推诿' then 1 else null end)                 as `推诿`,                          count(case when 解得对（一线话务员）（必填）不合格问题 = '未按客户需求受理业务' then 1 else null end) as `未按客户需求受理业务`,                          count(case when 解得对（一线话务员）（必填）不合格问题 = '未按规范执行' then 1 else null end)         as `未按规范执行`,                          count(case when 解得对（一线话务员）（必填）不合格问题 = '工单受理不规范' then 1 else null end)       as `工单受理不规范`,                          count(case when 解得对（一线话务员）（必填）不合格问题 = '工单无需生成' then 1 else null end)         as `工单无需生成`,                          count(case when 解得对（一线话务员）（必填）不合格问题 = '工单记录信息有误' then 1 else null end)     as `工单记录信息有误`,                          count(case                                    when 解得对（一线话务员）（必填）不合格问题 in                                         ('推诿', '未按客户需求受理业务', '未按规范执行', '工单受理不规范',                                          '工单无需生成', '工单记录信息有误')                                        then 1                                    else null end)                                                                          as `问题小计`                   from fwbz.{fwbz_table}) t1             order by case                          when 区域 = '全国' then 1                          when 区域 = '北方一中心' then 2                          when 区域 = '北方二中心' then 3                          when 区域 = '南方一中心' then 4                          when 区域 = '南方二中心' then 5 end) select t1.区域,        t1.抽检总量,        `倾听/引导不到位`,        答非所问,        未纠正客户错误信息,        t1.问题小计,        `听得懂合规率（目标值≥95%）`,        超长等候未告知,        `沟通/受理能力差`,        服务态度差,        温情服务不足,        介绍错误或关键信息不全,        t2.问题小计,        `讲得清合规率（目标值≥95%）`,        推诿,        未按客户需求受理业务,        未按规范执行,        工单受理不规范,        工单无需生成,        工单记录信息有误,        t3.问题小计,        `解得对合规率（目标值≥95%）` from t1          join t2 on t1.区域 = t2.区域          join t3 on t1.区域 = t3.区域  order by case                          when t1.区域 = '全国' then 1                          when t1.区域 = '北方一中心' then 2                          when t1.区域 = '北方二中心' then 3                          when t1.区域 = '南方一中心' then 4                          when t1.区域 = '南方二中心' then 5 end ;"
df2 = pd.read_sql(query2, connection)

#  合作伙伴抽检合规率
query3 = f"with t1 as (select 区域,                    客服代表所属合作单位,                    count(*)                                                                            as `抽检总量`,                    count(case when 听得懂（必填）不合格问题 = '倾听/引导不到位' then 1 else null end)    as `倾听/引导不到位`,                    count(case when 听得懂（必填）不合格问题 = '答非所问' then 1 else null end)           as `答非所问`,                    count(case when 听得懂（必填）不合格问题 = '未纠正客户错误信息' then 1 else null end) as `未纠正客户错误信息`,                    count(case                              when 听得懂（必填）不合格问题 in ('倾听/引导不到位', '答非所问', '未纠正客户错误信息')                                  then 1                              else null end)                                                            as `问题小计`             from fwbz.{fwbz_table}             group by 区域, 客服代表所属合作单位             union all             select '全国'                                                                              as 区域,                    客服代表所属合作单位,                    count(*)                                                                            as `抽检总量`,                    count(case when 听得懂（必填）不合格问题 = '倾听/引导不到位' then 1 else null end)    as `倾听/引导不到位`,                    count(case when 听得懂（必填）不合格问题 = '答非所问' then 1 else null end)           as `答非所问`,                    count(case when 听得懂（必填）不合格问题 = '未纠正客户错误信息' then 1 else null end) as `未纠正客户错误信息`,                    count(case                              when 听得懂（必填）不合格问题 in ('倾听/引导不到位', '答非所问', '未纠正客户错误信息')                                  then 1                              else null end)                                                            as `问题小计`             from fwbz.{fwbz_table}             group by 客服代表所属合作单位             union all             select '全国'                                                                              as 区域,                    '合计'                                                                              as 客服代表所属合作单位,                    count(*)                                                                            as `抽检总量`,                    count(case when 听得懂（必填）不合格问题 = '倾听/引导不到位' then 1 else null end)    as `倾听/引导不到位`,                    count(case when 听得懂（必填）不合格问题 = '答非所问' then 1 else null end)           as `答非所问`,                    count(case when 听得懂（必填）不合格问题 = '未纠正客户错误信息' then 1 else null end) as `未纠正客户错误信息`,                    count(case                              when 听得懂（必填）不合格问题 in ('倾听/引导不到位', '答非所问', '未纠正客户错误信息')                                  then 1                              else null end)                                                            as `问题小计`             from fwbz.{fwbz_table}             union all             select 区域,                    '合计'                                                                              as 客服代表所属合作单位,                    count(*)                                                                            as `抽检总量`,                    count(case when 听得懂（必填）不合格问题 = '倾听/引导不到位' then 1 else null end)    as `倾听/引导不到位`,                    count(case when 听得懂（必填）不合格问题 = '答非所问' then 1 else null end)           as `答非所问`,                    count(case when 听得懂（必填）不合格问题 = '未纠正客户错误信息' then 1 else null end) as `未纠正客户错误信息`,                    count(case                              when 听得懂（必填）不合格问题 in ('倾听/引导不到位', '答非所问', '未纠正客户错误信息')                                  then 1                              else null end)                                                            as `问题小计`             from fwbz.{fwbz_table}             group by 区域),      t2 as (select 区域,                    客服代表所属合作单位,                    count(*)                                                                                as `抽检总量`,                    count(case when 讲得清（必填）不合格问题 = '超长等候未告知' then 1 else null end)         as `超长等候未告知`,                    count(case when 讲得清（必填）不合格问题 = '沟通/受理能力差' then 1 else null end)        as `沟通/受理能力差`,                    count(case when 讲得清（必填）不合格问题 = '服务态度差' then 1 else null end)             as `服务态度差`,                    count(case when 讲得清（必填）不合格问题 = '温情服务不足' then 1 else null end)           as `温情服务不足`,                    count(case when 讲得清（必填）不合格问题 = '介绍错误或关键信息不全' then 1 else null end) as `介绍错误或关键信息不全`,                    count(case                              when 讲得清（必填）不合格问题 in                                   ('超长等候未告知', '沟通/受理能力差', '服务态度差', '温情服务不足',                                    '介绍错误或关键信息不全')                                  then 1                              else null end)                                                                as `问题小计`             from fwbz.{fwbz_table}             group by 区域, 客服代表所属合作单位             union all             select '全国'                                                                                  as 区域,                    客服代表所属合作单位,                    count(*)                                                                                as `抽检总量`,                    count(case when 讲得清（必填）不合格问题 = '超长等候未告知' then 1 else null end)         as `超长等候未告知`,                    count(case when 讲得清（必填）不合格问题 = '沟通/受理能力差' then 1 else null end)        as `沟通/受理能力差`,                    count(case when 讲得清（必填）不合格问题 = '服务态度差' then 1 else null end)             as `服务态度差`,                    count(case when 讲得清（必填）不合格问题 = '温情服务不足' then 1 else null end)           as `温情服务不足`,                    count(case when 讲得清（必填）不合格问题 = '介绍错误或关键信息不全' then 1 else null end) as `介绍错误或关键信息不全`,                    count(case                              when 讲得清（必填）不合格问题 in                                   ('超长等候未告知', '沟通/受理能力差', '服务态度差', '温情服务不足',                                    '介绍错误或关键信息不全')                                  then 1                              else null end)                                                                as `问题小计`             from fwbz.{fwbz_table}             group by 客服代表所属合作单位             union all             select '全国'                                                                                  as 区域,                    '合计'                                                                                  as 客服代表所属合作单位,                    count(*)                                                                                as `抽检总量`,                    count(case when 讲得清（必填）不合格问题 = '超长等候未告知' then 1 else null end)         as `超长等候未告知`,                    count(case when 讲得清（必填）不合格问题 = '沟通/受理能力差' then 1 else null end)        as `沟通/受理能力差`,                    count(case when 讲得清（必填）不合格问题 = '服务态度差' then 1 else null end)             as `服务态度差`,                    count(case when 讲得清（必填）不合格问题 = '温情服务不足' then 1 else null end)           as `温情服务不足`,                    count(case when 讲得清（必填）不合格问题 = '介绍错误或关键信息不全' then 1 else null end) as `介绍错误或关键信息不全`,                    count(case                              when 讲得清（必填）不合格问题 in                                   ('超长等候未告知', '沟通/受理能力差', '服务态度差', '温情服务不足',                                    '介绍错误或关键信息不全')                                  then 1                              else null end)                                                                as `问题小计`             from fwbz.{fwbz_table}             union all             select 区域,                    '合计'                                                                                  as 客服代表所属合作单位,                    count(*)                                                                                as `抽检总量`,                    count(case when 讲得清（必填）不合格问题 = '超长等候未告知' then 1 else null end)         as `超长等候未告知`,                    count(case when 讲得清（必填）不合格问题 = '沟通/受理能力差' then 1 else null end)        as `沟通/受理能力差`,                    count(case when 讲得清（必填）不合格问题 = '服务态度差' then 1 else null end)             as `服务态度差`,                    count(case when 讲得清（必填）不合格问题 = '温情服务不足' then 1 else null end)           as `温情服务不足`,                    count(case when 讲得清（必填）不合格问题 = '介绍错误或关键信息不全' then 1 else null end) as `介绍错误或关键信息不全`,                    count(case                              when 讲得清（必填）不合格问题 in                                   ('超长等候未告知', '沟通/受理能力差', '服务态度差', '温情服务不足',                                    '介绍错误或关键信息不全')                                  then 1                              else null end)                                                                as `问题小计`             from fwbz.{fwbz_table}             group by 区域),      t3 as (select 区域,                    客服代表所属合作单位,                    count(*)                                                                                          as `抽检总量`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '推诿' then 1 else null end)                 as `推诿`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '未按客户需求受理业务' then 1 else null end) as `未按客户需求受理业务`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '未按规范执行' then 1 else null end)         as `未按规范执行`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '工单受理不规范' then 1 else null end)       as `工单受理不规范`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '工单无需生成' then 1 else null end)         as `工单无需生成`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '工单记录信息有误' then 1 else null end)     as `工单记录信息有误`,                    count(case                              when 解得对（一线话务员）（必填）不合格问题 in                                   ('推诿', '未按客户需求受理业务', '未按规范执行', '工单受理不规范',                                    '工单无需生成', '工单记录信息有误')                                  then 1                              else null end)                                                                          as `问题小计`             from fwbz.{fwbz_table}             group by 区域, 客服代表所属合作单位             union all             select '全国'                                                                                            as 区域,                    客服代表所属合作单位,                    count(*)                                                                                          as `抽检总量`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '推诿' then 1 else null end)                 as `推诿`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '未按客户需求受理业务' then 1 else null end) as `未按客户需求受理业务`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '未按规范执行' then 1 else null end)         as `未按规范执行`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '工单受理不规范' then 1 else null end)       as `工单受理不规范`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '工单无需生成' then 1 else null end)         as `工单无需生成`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '工单记录信息有误' then 1 else null end)     as `工单记录信息有误`,                    count(case                              when 解得对（一线话务员）（必填）不合格问题 in                                   ('推诿', '未按客户需求受理业务', '未按规范执行', '工单受理不规范',                                    '工单无需生成', '工单记录信息有误')                                  then 1                              else null end)                                                                          as `问题小计`             from fwbz.{fwbz_table}             group by 客服代表所属合作单位             union all             select '全国'                                                                                            as 区域,                    '合计'                                                                                            as 客服代表所属合作单位,                    count(*)                                                                                          as `抽检总量`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '推诿' then 1 else null end)                 as `推诿`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '未按客户需求受理业务' then 1 else null end) as `未按客户需求受理业务`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '未按规范执行' then 1 else null end)         as `未按规范执行`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '工单受理不规范' then 1 else null end)       as `工单受理不规范`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '工单无需生成' then 1 else null end)         as `工单无需生成`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '工单记录信息有误' then 1 else null end)     as `工单记录信息有误`,                    count(case                              when 解得对（一线话务员）（必填）不合格问题 in                                   ('推诿', '未按客户需求受理业务', '未按规范执行', '工单受理不规范',                                    '工单无需生成', '工单记录信息有误')                                  then 1                              else null end)                                                                          as `问题小计`             from fwbz.{fwbz_table}             union all             select 区域,                    '合计'                                                                                            as 客服代表所属合作单位,                    count(*)                                                                                          as `抽检总量`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '推诿' then 1 else null end)                 as `推诿`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '未按客户需求受理业务' then 1 else null end) as `未按客户需求受理业务`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '未按规范执行' then 1 else null end)         as `未按规范执行`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '工单受理不规范' then 1 else null end)       as `工单受理不规范`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '工单无需生成' then 1 else null end)         as `工单无需生成`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '工单记录信息有误' then 1 else null end)     as `工单记录信息有误`,                    count(case                              when 解得对（一线话务员）（必填）不合格问题 in                                   ('推诿', '未按客户需求受理业务', '未按规范执行', '工单受理不规范',                                    '工单无需生成', '工单记录信息有误')                                  then 1                              else null end)                                                                          as `问题小计`             from fwbz.{fwbz_table}             group by 区域) select t1.区域,        t1.客服代表所属合作单位,        t1.抽检总量,        t1.`倾听/引导不到位`,        t1.答非所问,        t1.未纠正客户错误信息,        t1.问题小计,        (t1.抽检总量 - t1.问题小计) / t1.抽检总量 as `听得懂合规率（目标值≥95%）`,        t2.超长等候未告知,        t2.`沟通/受理能力差`,        t2.服务态度差,        t2.温情服务不足,        t2.介绍错误或关键信息不全,        t2.问题小计,        (t2.抽检总量 - t2.问题小计) / t2.抽检总量 as `讲得清合规率（目标值≥95%）`,        t3.推诿,        t3.未按客户需求受理业务,        t3.未按规范执行,        t3.工单受理不规范,        t3.工单无需生成,        t3.工单记录信息有误,        t3.问题小计,        (t3.抽检总量 - t3.问题小计) / t3.抽检总量 as `解得对合规率（目标值≥95%）` from t1          join t2 on t1.区域 = t2.区域 and t1.客服代表所属合作单位 = t2.客服代表所属合作单位          join t3 on t1.区域 = t3.区域 and t1.客服代表所属合作单位 = t3.客服代表所属合作单位 order by case              when t1.区域 = '全国' and t1.客服代表所属合作单位 = '北京电信发展有限公司' then 1              when t1.区域 = '全国' and t1.客服代表所属合作单位 = '北京通软联合信息技术有限公司' then 2              when t1.区域 = '全国' and t1.客服代表所属合作单位 = '河南正华电讯有限公司' then 3              when t1.区域 = '全国' and t1.客服代表所属合作单位 = '济南云上电子科技有限公司' then 4              when t1.区域 = '全国' and t1.客服代表所属合作单位 = '京北方信息技术股份有限公司' then 5              when t1.区域 = '全国' and t1.客服代表所属合作单位 = '山东省保时通信息网络有限公司' then 6              when t1.区域 = '全国' and t1.客服代表所属合作单位 = '四川通发广进人力资源管理咨询有限公司' then 7              when t1.区域 = '全国' and t1.客服代表所属合作单位 = '中通信息服务有限公司' then 8              when t1.区域 = '全国' and t1.客服代表所属合作单位 = '合计' then 9              when t1.区域 = '北方一中心' and t1.客服代表所属合作单位 = '北京电信发展有限公司' then 10              when t1.区域 = '北方一中心' and t1.客服代表所属合作单位 = '北京通软联合信息技术有限公司' then 11              when t1.区域 = '北方一中心' and t1.客服代表所属合作单位 = '河南正华电讯有限公司' then 12              when t1.区域 = '北方一中心' and t1.客服代表所属合作单位 = '山东省保时通信息网络有限公司' then 13              when t1.区域 = '北方一中心' and t1.客服代表所属合作单位 = '合计' then 13              when t1.区域 = '北方二中心' and t1.客服代表所属合作单位 = '北京通软联合信息技术有限公司' then 14              when t1.区域 = '北方二中心' and t1.客服代表所属合作单位 = '河南正华电讯有限公司' then 15              when t1.区域 = '北方二中心' and t1.客服代表所属合作单位 = '济南云上电子科技有限公司' then 16              when t1.区域 = '北方二中心' and t1.客服代表所属合作单位 = '山东省保时通信息网络有限公司' then 17              when t1.区域 = '北方二中心' and t1.客服代表所属合作单位 = '合计' then 18              when t1.区域 = '南方一中心' and t1.客服代表所属合作单位 = '北京通软联合信息技术有限公司' then 19              when t1.区域 = '南方一中心' and t1.客服代表所属合作单位 = '河南正华电讯有限公司' then 20              when t1.区域 = '南方一中心' and t1.客服代表所属合作单位 = '四川通发广进人力资源管理咨询有限公司' then 21              when t1.区域 = '南方一中心' and t1.客服代表所属合作单位 = '合计' then 22              when t1.区域 = '南方二中心' and t1.客服代表所属合作单位 = '河南正华电讯有限公司' then 23              when t1.区域 = '南方二中心' and t1.客服代表所属合作单位 = '京北方信息技术股份有限公司' then 24              when t1.区域 = '南方二中心' and t1.客服代表所属合作单位 = '山东省保时通信息网络有限公司' then 25              when t1.区域 = '南方二中心' and t1.客服代表所属合作单位 = '中通信息服务有限公司' then 26              when t1.区域 = '南方二中心' and t1.客服代表所属合作单位 = '合计' then 27              end ;   "
df3 = pd.read_sql(query3, connection)

# 高星客服代表合规率
query4 = f"with t1 as (select 区域,                    case                        when 是否为高星客服代表 = '是' then '高星'                        when 是否为高星客服代表 = '否' then '非高星'                        end                                                                             as `客服代表`,                    count(*)                                                                            as `抽检总量`,                    count(case when 听得懂（必填）不合格问题 = '倾听/引导不到位' then 1 else null end)    as `倾听/引导不到位`,                    count(case when 听得懂（必填）不合格问题 = '答非所问' then 1 else null end)           as `答非所问`,                    count(case when 听得懂（必填）不合格问题 = '未纠正客户错误信息' then 1 else null end) as `未纠正客户错误信息`,                    count(case                              when 听得懂（必填）不合格问题 in ('倾听/引导不到位', '答非所问', '未纠正客户错误信息')                                  then 1                              else null end)                                                            as `问题小计`             from fwbz.{fwbz_table}             group by 区域,                      case                          when 是否为高星客服代表 = '是' then '高星'                          when 是否为高星客服代表 = '否' then '非高星'                          end             union all             select '全国'                                                                              as 区域,                    case                        when 是否为高星客服代表 = '是' then '高星'                        when 是否为高星客服代表 = '否' then '非高星'                        end                                                                             as `客服代表`,                    count(*)                                                                            as `抽检总量`,                    count(case when 听得懂（必填）不合格问题 = '倾听/引导不到位' then 1 else null end)    as `倾听/引导不到位`,                    count(case when 听得懂（必填）不合格问题 = '答非所问' then 1 else null end)           as `答非所问`,                    count(case when 听得懂（必填）不合格问题 = '未纠正客户错误信息' then 1 else null end) as `未纠正客户错误信息`,                    count(case                              when 听得懂（必填）不合格问题 in ('倾听/引导不到位', '答非所问', '未纠正客户错误信息')                                  then 1                              else null end)                                                            as `问题小计`             from fwbz.{fwbz_table}             group by case                          when 是否为高星客服代表 = '是' then '高星'                          when 是否为高星客服代表 = '否' then '非高星'                          end),      t2 as (select 区域,                    case                        when 是否为高星客服代表 = '是' then '高星'                        when 是否为高星客服代表 = '否' then '非高星'                        end                                                                                 as `客服代表`,                    count(*)                                                                                as `抽检总量`,                    count(case when 讲得清（必填）不合格问题 = '超长等候未告知' then 1 else null end)         as `超长等候未告知`,                    count(case when 讲得清（必填）不合格问题 = '沟通/受理能力差' then 1 else null end)        as `沟通/受理能力差`,                    count(case when 讲得清（必填）不合格问题 = '服务态度差' then 1 else null end)             as `服务态度差`,                    count(case when 讲得清（必填）不合格问题 = '温情服务不足' then 1 else null end)           as `温情服务不足`,                    count(case when 讲得清（必填）不合格问题 = '介绍错误或关键信息不全' then 1 else null end) as `介绍错误或关键信息不全`,                    count(case                              when 讲得清（必填）不合格问题 in                                   ('超长等候未告知', '沟通/受理能力差', '服务态度差', '温情服务不足',                                    '介绍错误或关键信息不全')                                  then 1                              else null end)                                                                as `问题小计`             from fwbz.{fwbz_table}             group by 区域,                      case                          when 是否为高星客服代表 = '是' then '高星'                          when 是否为高星客服代表 = '否' then '非高星'                          end             union all             select '全国'                                                                                  as 区域,                    case                        when 是否为高星客服代表 = '是' then '高星'                        when 是否为高星客服代表 = '否' then '非高星'                        end                                                                                 as `客服代表`,                    count(*)                                                                                as `抽检总量`,                    count(case when 讲得清（必填）不合格问题 = '超长等候未告知' then 1 else null end)         as `超长等候未告知`,                    count(case when 讲得清（必填）不合格问题 = '沟通/受理能力差' then 1 else null end)        as `沟通/受理能力差`,                    count(case when 讲得清（必填）不合格问题 = '服务态度差' then 1 else null end)             as `服务态度差`,                    count(case when 讲得清（必填）不合格问题 = '温情服务不足' then 1 else null end)           as `温情服务不足`,                    count(case when 讲得清（必填）不合格问题 = '介绍错误或关键信息不全' then 1 else null end) as `介绍错误或关键信息不全`,                    count(case                              when 讲得清（必填）不合格问题 in                                   ('超长等候未告知', '沟通/受理能力差', '服务态度差', '温情服务不足',                                    '介绍错误或关键信息不全')                                  then 1                              else null end)                                                                as `问题小计`             from fwbz.{fwbz_table}             group by case                          when 是否为高星客服代表 = '是' then '高星'                          when 是否为高星客服代表 = '否' then '非高星'                          end),      t3 as (select 区域,                    case                        when 是否为高星客服代表 = '是' then '高星'                        when 是否为高星客服代表 = '否' then '非高星'                        end                                                                                           as `客服代表`,                    count(*)                                                                                          as `抽检总量`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '推诿' then 1 else null end)                 as `推诿`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '未按客户需求受理业务' then 1 else null end) as `未按客户需求受理业务`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '未按规范执行' then 1 else null end)         as `未按规范执行`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '工单受理不规范' then 1 else null end)       as `工单受理不规范`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '工单无需生成' then 1 else null end)         as `工单无需生成`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '工单记录信息有误' then 1 else null end)     as `工单记录信息有误`,                    count(case                              when 解得对（一线话务员）（必填）不合格问题 in                                   ('推诿', '未按客户需求受理业务', '未按规范执行', '工单受理不规范',                                    '工单无需生成', '工单记录信息有误')                                  then 1                              else null end)                                                                          as `问题小计`             from fwbz.{fwbz_table}             group by 区域,                      case                          when 是否为高星客服代表 = '是' then '高星'                          when 是否为高星客服代表 = '否' then '非高星'                          end             union all             select '全国'                                                                                            as 区域,                    case                        when 是否为高星客服代表 = '是' then '高星'                        when 是否为高星客服代表 = '否' then '非高星'                        end                                                                                           as `客服代表`,                    count(*)                                                                                          as `抽检总量`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '推诿' then 1 else null end)                 as `推诿`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '未按客户需求受理业务' then 1 else null end) as `未按客户需求受理业务`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '未按规范执行' then 1 else null end)         as `未按规范执行`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '工单受理不规范' then 1 else null end)       as `工单受理不规范`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '工单无需生成' then 1 else null end)         as `工单无需生成`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '工单记录信息有误' then 1 else null end)     as `工单记录信息有误`,                    count(case                              when 解得对（一线话务员）（必填）不合格问题 in                                   ('推诿', '未按客户需求受理业务', '未按规范执行', '工单受理不规范',                                    '工单无需生成', '工单记录信息有误')                                  then 1                              else null end)                                                                          as `问题小计`             from fwbz.{fwbz_table}             group by case                          when 是否为高星客服代表 = '是' then '高星'                          when 是否为高星客服代表 = '否' then '非高星'                          end) select t1.区域,        t1.客服代表,        t1.抽检总量,        t1.`倾听/引导不到位`,        t1.答非所问,        t1.未纠正客户错误信息,        t1.问题小计,        (t1.抽检总量 - t1.问题小计) / t1.抽检总量 as `听得懂合规率（目标值≥95%）`,        t2.超长等候未告知,        t2.`沟通/受理能力差`,        t2.服务态度差,        t2.温情服务不足,        t2.介绍错误或关键信息不全,        t2.问题小计,        (t2.抽检总量 - t2.问题小计) / t2.抽检总量 as `讲得清合规率（目标值≥95%）`,        t3.推诿,        t3.未按客户需求受理业务,        t3.未按规范执行,        t3.工单受理不规范,        t3.工单无需生成,        t3.工单记录信息有误,        t3.问题小计,        (t3.抽检总量 - t3.问题小计) / t3.抽检总量 as `解得对合规率（目标值≥95%）` from t1          join t2 on t1.区域 = t2.区域 and t1.客服代表 = t2.客服代表          join t3 on t1.区域 = t3.区域 and t1.客服代表 = t3.客服代表 order by     case when t1.区域 = '全国' and t1.客服代表 = '高星' then 1 when t1.区域 = '全国' and t1.客服代表 = '非高星' then 2 when t1.区域 = '北方一中心' and t1.客服代表 = '高星' then 3 when t1.区域 = '北方一中心' and t1.客服代表 = '非高星' then 4 when t1.区域 = '北方二中心' and t1.客服代表 = '高星' then 5 when t1.区域 = '北方二中心' and t1.客服代表 = '非高星' then 6 when t1.区域 = '南方一中心' and t1.客服代表 = '高星' then 7 when t1.区域 = '南方一中心' and t1.客服代表 = '非高星' then 8 when t1.区域 = '南方二中心' and t1.客服代表 = '高星' then 9 when t1.区域 = '南方二中心' and t1.客服代表 = '非高星' then 10 end ;     "
df4 = pd.read_sql(query4, connection)

# 重点场景合规率
query5 = f"with t1 as (select 区域,                    服务场景,                    count(*)                                                                            as `抽检总量`,                    count(case when 听得懂（必填）不合格问题 = '倾听/引导不到位' then 1 else null end)    as `倾听/引导不到位`,                    count(case when 听得懂（必填）不合格问题 = '答非所问' then 1 else null end)           as `答非所问`,                    count(case when 听得懂（必填）不合格问题 = '未纠正客户错误信息' then 1 else null end) as `未纠正客户错误信息`,                    count(case                              when 听得懂（必填）不合格问题 in ('倾听/引导不到位', '答非所问', '未纠正客户错误信息')                                  then 1                              else null end)                                                            as `问题小计`             from fwbz.{fwbz_table}             group by 区域, 服务场景             union all             select '全国'                                                                              as 区域,                    服务场景,                    count(*)                                                                            as `抽检总量`,                    count(case when 听得懂（必填）不合格问题 = '倾听/引导不到位' then 1 else null end)    as `倾听/引导不到位`,                    count(case when 听得懂（必填）不合格问题 = '答非所问' then 1 else null end)           as `答非所问`,                    count(case when 听得懂（必填）不合格问题 = '未纠正客户错误信息' then 1 else null end) as `未纠正客户错误信息`,                    count(case                              when 听得懂（必填）不合格问题 in ('倾听/引导不到位', '答非所问', '未纠正客户错误信息')                                  then 1                              else null end)                                                            as `问题小计`             from fwbz.{fwbz_table}             group by 服务场景),      t2 as (select 区域,                    服务场景,                    count(*)                                                                                as `抽检总量`,                    count(case when 讲得清（必填）不合格问题 = '超长等候未告知' then 1 else null end)         as `超长等候未告知`,                    count(case when 讲得清（必填）不合格问题 = '沟通/受理能力差' then 1 else null end)        as `沟通/受理能力差`,                    count(case when 讲得清（必填）不合格问题 = '服务态度差' then 1 else null end)             as `服务态度差`,                    count(case when 讲得清（必填）不合格问题 = '温情服务不足' then 1 else null end)           as `温情服务不足`,                    count(case when 讲得清（必填）不合格问题 = '介绍错误或关键信息不全' then 1 else null end) as `介绍错误或关键信息不全`,                    count(case                              when 讲得清（必填）不合格问题 in                                   ('超长等候未告知', '沟通/受理能力差', '服务态度差', '温情服务不足',                                    '介绍错误或关键信息不全')                                  then 1                              else null end)                                                                as `问题小计`             from fwbz.{fwbz_table}             group by 区域, 服务场景             union all             select '全国'                                                                                  as 区域,                    服务场景,                    count(*)                                                                                as `抽检总量`,                    count(case when 讲得清（必填）不合格问题 = '超长等候未告知' then 1 else null end)         as `超长等候未告知`,                    count(case when 讲得清（必填）不合格问题 = '沟通/受理能力差' then 1 else null end)        as `沟通/受理能力差`,                    count(case when 讲得清（必填）不合格问题 = '服务态度差' then 1 else null end)             as `服务态度差`,                    count(case when 讲得清（必填）不合格问题 = '温情服务不足' then 1 else null end)           as `温情服务不足`,                    count(case when 讲得清（必填）不合格问题 = '介绍错误或关键信息不全' then 1 else null end) as `介绍错误或关键信息不全`,                    count(case                              when 讲得清（必填）不合格问题 in                                   ('超长等候未告知', '沟通/受理能力差', '服务态度差', '温情服务不足',                                    '介绍错误或关键信息不全')                                  then 1                              else null end)                                                                as `问题小计`             from fwbz.{fwbz_table}             group by 服务场景),      t3 as (select 区域,                    服务场景,                    count(*)                                                                                          as `抽检总量`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '推诿' then 1 else null end)                 as `推诿`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '未按客户需求受理业务' then 1 else null end) as `未按客户需求受理业务`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '未按规范执行' then 1 else null end)         as `未按规范执行`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '工单受理不规范' then 1 else null end)       as `工单受理不规范`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '工单无需生成' then 1 else null end)         as `工单无需生成`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '工单记录信息有误' then 1 else null end)     as `工单记录信息有误`,                    count(case                              when 解得对（一线话务员）（必填）不合格问题 in                                   ('推诿', '未按客户需求受理业务', '未按规范执行', '工单受理不规范',                                    '工单无需生成', '工单记录信息有误')                                  then 1                              else null end)                                                                          as `问题小计`             from fwbz.{fwbz_table}             group by 区域,                      服务场景             union all             select '全国'                                                                                            as 区域,                    服务场景,                    count(*)                                                                                          as `抽检总量`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '推诿' then 1 else null end)                 as `推诿`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '未按客户需求受理业务' then 1 else null end) as `未按客户需求受理业务`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '未按规范执行' then 1 else null end)         as `未按规范执行`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '工单受理不规范' then 1 else null end)       as `工单受理不规范`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '工单无需生成' then 1 else null end)         as `工单无需生成`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '工单记录信息有误' then 1 else null end)     as `工单记录信息有误`,                    count(case                              when 解得对（一线话务员）（必填）不合格问题 in                                   ('推诿', '未按客户需求受理业务', '未按规范执行', '工单受理不规范',                                    '工单无需生成', '工单记录信息有误')                                  then 1                              else null end)                                                                          as `问题小计`             from fwbz.{fwbz_table}             group by 服务场景) select t1.区域,        t1.服务场景,        t1.抽检总量,        t1.`倾听/引导不到位`,        t1.答非所问,        t1.未纠正客户错误信息,        t1.问题小计,        (t1.抽检总量 - t1.问题小计) / t1.抽检总量 as `听得懂合规率（目标值≥95%）`,        t2.超长等候未告知,        t2.`沟通/受理能力差`,        t2.服务态度差,        t2.温情服务不足,        t2.介绍错误或关键信息不全,        t2.问题小计,        (t2.抽检总量 - t2.问题小计) / t2.抽检总量 as `讲得清合规率（目标值≥95%）`,        t3.推诿,        t3.未按客户需求受理业务,        t3.未按规范执行,        t3.工单受理不规范,        t3.工单无需生成,        t3.工单记录信息有误,        t3.问题小计,        (t3.抽检总量 - t3.问题小计) / t3.抽检总量 as `解得对合规率（目标值≥95%）` from t1          join t2 on t1.区域 = t2.区域 and t1.服务场景 = t2.服务场景          join t3 on t1.区域 = t3.区域 and t1.服务场景 = t3.服务场景 order by case              when t1.区域 = '全国' and t1.服务场景 = '套餐变更' then 1              when t1.区域 = '全国' and t1.服务场景 = '销户退网' then 2              when t1.区域 = '全国' and t1.服务场景 = '局方停机' then 3              when t1.区域 = '全国' and t1.服务场景 = '合约/活动问题' then 4              when t1.区域 = '全国' and t1.服务场景 = '流量争议' then 5              when t1.区域 = '全国' and t1.服务场景 = '套餐/月租争议' then 6              when t1.区域 = '全国' and t1.服务场景 = '不知情定制' then 7              when t1.区域 = '全国' and t1.服务场景 = '前工单/催单问题' then 8              when t1.区域 = '全国' and t1.服务场景 = '办理过程复杂、不便捷' then 9              when t1.区域 = '全国' and t1.服务场景 = '移网网络问题' then 10              when t1.区域 = '全国' and t1.服务场景 = '携号转网' then 11              when t1.区域 = '全国' and t1.服务场景 = '固网网络问题' then 12              when t1.区域 = '全国' and t1.服务场景 = '靓号争议' then 13              when t1.区域 = '全国' and t1.服务场景 = '营业厅问题' then 14              when t1.区域 = '全国' and t1.服务场景 = '交费赠款问题' then 15              when t1.区域 = '全国' and t1.服务场景 = '增值业务计费争议' then 16              when t1.区域 = '全国' and t1.服务场景 = '产品使用争议' then 17              when t1.区域 = '全国' and t1.服务场景 = '号卡订单' then 18              when t1.区域 = '全国' and t1.服务场景 = '账详单问题' then 19              when t1.区域 = '全国' and t1.服务场景 = '主副卡' then 20              when t1.区域 = '北方一中心' and t1.服务场景 = '套餐变更' then 21              when t1.区域 = '北方一中心' and t1.服务场景 = '销户退网' then 22              when t1.区域 = '北方一中心' and t1.服务场景 = '局方停机' then 23              when t1.区域 = '北方一中心' and t1.服务场景 = '合约/活动问题' then 24              when t1.区域 = '北方一中心' and t1.服务场景 = '流量争议' then 25              when t1.区域 = '北方一中心' and t1.服务场景 = '套餐/月租争议' then 26              when t1.区域 = '北方一中心' and t1.服务场景 = '不知情定制' then 27              when t1.区域 = '北方一中心' and t1.服务场景 = '前工单/催单问题' then 28              when t1.区域 = '北方一中心' and t1.服务场景 = '办理过程复杂、不便捷' then 29              when t1.区域 = '北方一中心' and t1.服务场景 = '移网网络问题' then 30              when t1.区域 = '北方一中心' and t1.服务场景 = '携号转网' then 31              when t1.区域 = '北方一中心' and t1.服务场景 = '固网网络问题' then 32              when t1.区域 = '北方一中心' and t1.服务场景 = '靓号争议' then 33              when t1.区域 = '北方一中心' and t1.服务场景 = '营业厅问题' then 34              when t1.区域 = '北方一中心' and t1.服务场景 = '交费赠款问题' then 35              when t1.区域 = '北方一中心' and t1.服务场景 = '增值业务计费争议' then 36              when t1.区域 = '北方一中心' and t1.服务场景 = '产品使用争议' then 37              when t1.区域 = '北方一中心' and t1.服务场景 = '号卡订单' then 38              when t1.区域 = '北方一中心' and t1.服务场景 = '账详单问题' then 39              when t1.区域 = '北方一中心' and t1.服务场景 = '主副卡' then 40              when t1.区域 = '北方二中心' and t1.服务场景 = '套餐变更' then 41              when t1.区域 = '北方二中心' and t1.服务场景 = '销户退网' then 42              when t1.区域 = '北方二中心' and t1.服务场景 = '局方停机' then 43              when t1.区域 = '北方二中心' and t1.服务场景 = '合约/活动问题' then 44              when t1.区域 = '北方二中心' and t1.服务场景 = '流量争议' then 45              when t1.区域 = '北方二中心' and t1.服务场景 = '套餐/月租争议' then 46              when t1.区域 = '北方二中心' and t1.服务场景 = '不知情定制' then 47              when t1.区域 = '北方二中心' and t1.服务场景 = '前工单/催单问题' then 48              when t1.区域 = '北方二中心' and t1.服务场景 = '办理过程复杂、不便捷' then 49              when t1.区域 = '北方二中心' and t1.服务场景 = '移网网络问题' then 50              when t1.区域 = '北方二中心' and t1.服务场景 = '携号转网' then 51              when t1.区域 = '北方二中心' and t1.服务场景 = '固网网络问题' then 52              when t1.区域 = '北方二中心' and t1.服务场景 = '靓号争议' then 53              when t1.区域 = '北方二中心' and t1.服务场景 = '营业厅问题' then 54              when t1.区域 = '北方二中心' and t1.服务场景 = '交费赠款问题' then 55              when t1.区域 = '北方二中心' and t1.服务场景 = '增值业务计费争议' then 56              when t1.区域 = '北方二中心' and t1.服务场景 = '产品使用争议' then 57              when t1.区域 = '北方二中心' and t1.服务场景 = '号卡订单' then 58              when t1.区域 = '北方二中心' and t1.服务场景 = '账详单问题' then 59              when t1.区域 = '北方二中心' and t1.服务场景 = '主副卡' then 60              when t1.区域 = '南方一中心' and t1.服务场景 = '套餐变更' then 61              when t1.区域 = '南方一中心' and t1.服务场景 = '销户退网' then 62              when t1.区域 = '南方一中心' and t1.服务场景 = '局方停机' then 63              when t1.区域 = '南方一中心' and t1.服务场景 = '合约/活动问题' then 64              when t1.区域 = '南方一中心' and t1.服务场景 = '流量争议' then 65              when t1.区域 = '南方一中心' and t1.服务场景 = '套餐/月租争议' then 66              when t1.区域 = '南方一中心' and t1.服务场景 = '不知情定制' then 67              when t1.区域 = '南方一中心' and t1.服务场景 = '前工单/催单问题' then 68              when t1.区域 = '南方一中心' and t1.服务场景 = '办理过程复杂、不便捷' then 69              when t1.区域 = '南方一中心' and t1.服务场景 = '移网网络问题' then 70              when t1.区域 = '南方一中心' and t1.服务场景 = '携号转网' then 71              when t1.区域 = '南方一中心' and t1.服务场景 = '固网网络问题' then 72              when t1.区域 = '南方一中心' and t1.服务场景 = '靓号争议' then 73              when t1.区域 = '南方一中心' and t1.服务场景 = '营业厅问题' then 74              when t1.区域 = '南方一中心' and t1.服务场景 = '交费赠款问题' then 75              when t1.区域 = '南方一中心' and t1.服务场景 = '增值业务计费争议' then 76              when t1.区域 = '南方一中心' and t1.服务场景 = '产品使用争议' then 77              when t1.区域 = '南方一中心' and t1.服务场景 = '号卡订单' then 78              when t1.区域 = '南方一中心' and t1.服务场景 = '账详单问题' then 79              when t1.区域 = '南方一中心' and t1.服务场景 = '主副卡' then 80              when t1.区域 = '南方二中心' and t1.服务场景 = '套餐变更' then 81              when t1.区域 = '南方二中心' and t1.服务场景 = '销户退网' then 82              when t1.区域 = '南方二中心' and t1.服务场景 = '局方停机' then 83              when t1.区域 = '南方二中心' and t1.服务场景 = '合约/活动问题' then 84              when t1.区域 = '南方二中心' and t1.服务场景 = '流量争议' then 85              when t1.区域 = '南方二中心' and t1.服务场景 = '套餐/月租争议' then 86              when t1.区域 = '南方二中心' and t1.服务场景 = '不知情定制' then 87              when t1.区域 = '南方二中心' and t1.服务场景 = '前工单/催单问题' then 88              when t1.区域 = '南方二中心' and t1.服务场景 = '办理过程复杂、不便捷' then 89              when t1.区域 = '南方二中心' and t1.服务场景 = '移网网络问题' then 90              when t1.区域 = '南方二中心' and t1.服务场景 = '携号转网' then 91              when t1.区域 = '南方二中心' and t1.服务场景 = '固网网络问题' then 92              when t1.区域 = '南方二中心' and t1.服务场景 = '靓号争议' then 93              when t1.区域 = '南方二中心' and t1.服务场景 = '营业厅问题' then 94              when t1.区域 = '南方二中心' and t1.服务场景 = '交费赠款问题' then 95              when t1.区域 = '南方二中心' and t1.服务场景 = '增值业务计费争议' then 96              when t1.区域 = '南方二中心' and t1.服务场景 = '产品使用争议' then 97              when t1.区域 = '南方二中心' and t1.服务场景 = '号卡订单' then 98              when t1.区域 = '南方二中心' and t1.服务场景 = '账详单问题' then 99              when t1.区域 = '南方二中心' and t1.服务场景 = '主副卡' then 100              end;"
df5 = pd.read_sql(query5, connection)

# 省分合规率
query6 = f"with t1 as (select 区域,                    省分,                    count(*)                                                                            as `抽检总量`,                    count(case when 听得懂（必填）不合格问题 = '倾听/引导不到位' then 1 else null end)    as `倾听/引导不到位`,                    count(case when 听得懂（必填）不合格问题 = '答非所问' then 1 else null end)           as `答非所问`,                    count(case when 听得懂（必填）不合格问题 = '未纠正客户错误信息' then 1 else null end) as `未纠正客户错误信息`,                    count(case                              when 听得懂（必填）不合格问题 in ('倾听/引导不到位', '答非所问', '未纠正客户错误信息')                                  then 1                              else null end)                                                            as `问题小计`             from fwbz.{fwbz_table}             group by 区域,                      省分             union all             select '全国'                                                                              as 区域,                    '全国'                                                                              as `省分`,                    count(*)                                                                            as `抽检总量`,                    count(case when 听得懂（必填）不合格问题 = '倾听/引导不到位' then 1 else null end)    as `倾听/引导不到位`,                    count(case when 听得懂（必填）不合格问题 = '答非所问' then 1 else null end)           as `答非所问`,                    count(case when 听得懂（必填）不合格问题 = '未纠正客户错误信息' then 1 else null end) as `未纠正客户错误信息`,                    count(case                              when 听得懂（必填）不合格问题 in ('倾听/引导不到位', '答非所问', '未纠正客户错误信息')                                  then 1                              else null end)                                                            as `问题小计`             from fwbz.{fwbz_table}),      t2 as (select 区域,                    省分,                    count(*)                                                                                as `抽检总量`,                    count(case when 讲得清（必填）不合格问题 = '超长等候未告知' then 1 else null end)         as `超长等候未告知`,                    count(case when 讲得清（必填）不合格问题 = '沟通/受理能力差' then 1 else null end)        as `沟通/受理能力差`,                    count(case when 讲得清（必填）不合格问题 = '服务态度差' then 1 else null end)             as `服务态度差`,                    count(case when 讲得清（必填）不合格问题 = '温情服务不足' then 1 else null end)           as `温情服务不足`,                    count(case when 讲得清（必填）不合格问题 = '介绍错误或关键信息不全' then 1 else null end) as `介绍错误或关键信息不全`,                    count(case                              when 讲得清（必填）不合格问题 in                                   ('超长等候未告知', '沟通/受理能力差', '服务态度差', '温情服务不足',                                    '介绍错误或关键信息不全')                                  then 1                              else null end)                                                                as `问题小计`             from fwbz.{fwbz_table}             group by 区域,                      省分             union all             select '全国'                                                                                  as 区域,                    '全国'                                                                                  as `省分`,                    count(*)                                                                                as `抽检总量`,                    count(case when 讲得清（必填）不合格问题 = '超长等候未告知' then 1 else null end)         as `超长等候未告知`,                    count(case when 讲得清（必填）不合格问题 = '沟通/受理能力差' then 1 else null end)        as `沟通/受理能力差`,                    count(case when 讲得清（必填）不合格问题 = '服务态度差' then 1 else null end)             as `服务态度差`,                    count(case when 讲得清（必填）不合格问题 = '温情服务不足' then 1 else null end)           as `温情服务不足`,                    count(case when 讲得清（必填）不合格问题 = '介绍错误或关键信息不全' then 1 else null end) as `介绍错误或关键信息不全`,                    count(case                              when 讲得清（必填）不合格问题 in                                   ('超长等候未告知', '沟通/受理能力差', '服务态度差', '温情服务不足',                                    '介绍错误或关键信息不全')                                  then 1                              else null end)                                                                as `问题小计`             from fwbz.{fwbz_table}),      t3 as (select 区域,                    省分,                    count(*)                                                                                          as `抽检总量`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '推诿' then 1 else null end)                 as `推诿`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '未按客户需求受理业务' then 1 else null end) as `未按客户需求受理业务`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '未按规范执行' then 1 else null end)         as `未按规范执行`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '工单受理不规范' then 1 else null end)       as `工单受理不规范`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '工单无需生成' then 1 else null end)         as `工单无需生成`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '工单记录信息有误' then 1 else null end)     as `工单记录信息有误`,                    count(case                              when 解得对（一线话务员）（必填）不合格问题 in                                   ('推诿', '未按客户需求受理业务', '未按规范执行', '工单受理不规范',                                    '工单无需生成', '工单记录信息有误')                                  then 1                              else null end)                                                                          as `问题小计`             from fwbz.{fwbz_table}             group by 区域,                      省分             union all             select '全国'                                                                                            as 区域,                    '全国'                                                                                            as `省分`,                    count(*)                                                                                          as `抽检总量`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '推诿' then 1 else null end)                 as `推诿`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '未按客户需求受理业务' then 1 else null end) as `未按客户需求受理业务`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '未按规范执行' then 1 else null end)         as `未按规范执行`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '工单受理不规范' then 1 else null end)       as `工单受理不规范`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '工单无需生成' then 1 else null end)         as `工单无需生成`,                    count(case when 解得对（一线话务员）（必填）不合格问题 = '工单记录信息有误' then 1 else null end)     as `工单记录信息有误`,                    count(case                              when 解得对（一线话务员）（必填）不合格问题 in                                   ('推诿', '未按客户需求受理业务', '未按规范执行', '工单受理不规范',                                    '工单无需生成', '工单记录信息有误')                                  then 1                              else null end)                                                                          as `问题小计`             from fwbz.{fwbz_table}) select t1.区域,        t1.省分,        t1.抽检总量,        t1.`倾听/引导不到位`,        t1.答非所问,        t1.未纠正客户错误信息,        t1.问题小计,        (t1.抽检总量 - t1.问题小计) / t1.抽检总量 as `听得懂合规率（目标值≥95%）`,        t2.超长等候未告知,        t2.`沟通/受理能力差`,        t2.服务态度差,        t2.温情服务不足,        t2.介绍错误或关键信息不全,        t2.问题小计,        (t2.抽检总量 - t2.问题小计) / t2.抽检总量 as `讲得清合规率（目标值≥95%）`,        t3.推诿,        t3.未按客户需求受理业务,        t3.未按规范执行,        t3.工单受理不规范,        t3.工单无需生成,        t3.工单记录信息有误,        t3.问题小计,        (t3.抽检总量 - t3.问题小计) / t3.抽检总量 as `解得对合规率（目标值≥95%）` from t1          join t2 on t1.区域 = t2.区域 and t1.省分  = t2.省分          join t3 on t1.区域 = t3.区域 and t1.省分 = t3.省分 order by case              when t1.省分 = '全国' then 1              when t1.省分 = '内蒙古' then 2              when t1.省分 = '北京' then 3              when t1.省分 = '吉林' then 4              when t1.省分 = '山西' then 5              when t1.省分 = '江苏' then 6              when t1.省分 = '河北' then 7              when t1.省分 = '天津' then 8              when t1.省分 = '山东' then 9              when t1.省分 = '河南' then 10              when t1.省分 = '辽宁' then 11              when t1.省分 = '黑龙江' then 12              when t1.省分 = '云南' then 13              when t1.省分 = '四川' then 14              when t1.省分 = '宁夏' then 15              when t1.省分 = '新疆' then 16              when t1.省分 = '浙江' then 17              when t1.省分 = '湖北' then 18              when t1.省分 = '甘肃' then 19              when t1.省分 = '西藏' then 20              when t1.省分 = '贵州' then 21              when t1.省分 = '重庆' then 22              when t1.省分 = '陕西' then 23              when t1.省分 = '青海' then 24              when t1.省分 = '上海' then 25              when t1.省分 = '安徽' then 26              when t1.省分 = '广东' then 27              when t1.省分 = '广西' then 28              when t1.省分 = '江西' then 29              when t1.省分 = '海南' then 30              when t1.省分 = '湖南' then 31              when t1.省分 = '福建' then 32              end ;"
df6 = pd.read_sql(query6, connection)

# 创建一个Excel writer对象

writer = pd.ExcelWriter(f'C:/Users/14659/Desktop/热线温情服务百日攻坚{dt}.xlsx')

# 将DataFrame写入不同的sheet
df1.to_excel(writer, sheet_name='三个中心抽检情况周通报', index=False)
df2.to_excel(writer, sheet_name='区域合规率', index=False)
df3.to_excel(writer, sheet_name='合作伙伴合规率', index=False)
df4.to_excel(writer, sheet_name='高星客服代表合规率', index=False)
df5.to_excel(writer, sheet_name='重点场景合规率', index=False)
df6.to_excel(writer, sheet_name='省分合规率', index=False)
# 保存Excel文件
writer.save()

# 断开与数据库的连接
connection.close()
